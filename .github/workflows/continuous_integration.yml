---
name: continuous_integration

on:
  push:
    branches:
      - development
      - production
  pull_request:
    branches:
      - development
      - dockerized-testing

jobs:
  test_suite:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_HOST: localhost
          POSTGRES_DB: neon_law
      logic:
        image: neonlaw/logic
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_HOST: localhost
          POSTGRES_DB: neon_law
        ports:
          DATABASE_URL: postgres://postgres:password@postgres:5432/neon_law
          SHADOW_DATABASE_URL: postgres://postgres:password@postgres:5432/neon_law_shadow
          ROOT_DATABASE_URL: postgres://postgres:password@postgres:5432/postgres
          AUTH0_CLIENT_ID: ${{ secrets.LOGIC_AUTH0_CLIENT_ID }}
          AUTH0_CLIENT_SECRET: ${{ secrets.LOGIC_AUTH0_CLIENT_SECRET }}
          AUTH0_TENANT: neon-law-testing
          NODE_ENV: production
        ports:
          - 3000:3000

    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.x
        uses: actions/setup-python@v1
        with:
          python-version: "3.x"
      - name: Install Dependencies.
        run: yarn install --ignore-optional
      - name: Run Linting.
        run: yarn lint
      - name: Run TypeScript Type Checking.
        run: yarn check-types
      - name: Security Scanning
        uses: ajinabraham/njsscan-action@v5
        with:
          args: "."
      - name: Ensure latest autogenerated graphql-codegen code is up-to-date
        run: |
          yarn graphql-codegen
          git diff --exit-code
      - name: Test & publish code coverage
        uses: paambaati/codeclimate-action@v2.5.5
        env:
          CC_TEST_REPORTER_ID: ${{secrets.CC_TEST_REPORTER_ID}}
        with:
          coverageCommand: yarn test
      - name: Cypress run
        uses: cypress-io/github-action@v1
        with:
          start: yarn develop --verbose
          wait-on: "http://127.0.0.1:8000"
          wait-on-timeout: 180
        env:
          CYPRESS_AUTH_URL: ${{ secrets.CYPRESS_AUTH_URL }}
          CYPRESS_AUTH_CLIENT_ID: ${{ secrets.CYPRESS_AUTH_CLIENT_ID }}
          CYPRESS_AUTH_CLIENT_SECRET: ${{ secrets.CYPRESS_AUTH_CLIENT_SECRET }}
          CYPRESS_PORTAL_USER_PASSWORD: ${{ secrets.CYPRESS_PORTAL_USER_PASSWORD }}
          GATSBY_AUTH0_CALLBACK: http://127.0.0.1:8000/callback/
          GATSBY_AUTH0_DOMAIN: neon-law-testing.auth0.com
          GATSBY_AUTH0_CLIENT_ID: http://127.0.0.1:3000/graphql
      - name: Run Yarn Build.
        run: yarn build
        env:
          GATSBY_ACTIVE_ENV: staging
      - name: Run Lighthouse against a static dist dir
        uses: treosh/lighthouse-ci-action@v2
        with:
          configPath: "./.lighthouserc.json"
          uploadArtifacts: true
